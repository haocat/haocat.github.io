# SM4 Alg
2022/08/24
SM4分组密码算法
_GMT 0002-2012 SM4分组密码算法_
### 1. 算法结构
SM4密码算法是一个分组算法 分组长度为128bit  密钥长度为128bit，加密算法与密钥扩展算法都采用32轮非线性迭代结构 。数据解密和数据加密的算法结构相 同,只是轮密钥的使用顺序相反 ,解密轮密钥是加密轮密钥的逆序
**先将128比特密钥 MK 扩展为32个轮密钥 rk，再将该轮密钥与128比特明文 X 经过轮函数进行32次迭代后，选取最后四次迭代生成的结果 $X_{32},X_{33},X_{34},X_{35}$进行反序变换，该变换结果作为最终的密文 Y 输出。**
![20220826145225](https://cdn.jsdelivr.net/gh/haocat/img_bed@master/markdown/security/20220826145225.png)

### 2. 密钥及密钥参量
-   加密密钥长度为 128比 特 ,表 示为 $MK=(MK_0 ,MK_1,MK_2,MK_3), MK_i(i=0,1,2,3)$为字 。
-   轮密钥表示为$(rk_0,rk_1,...rk_{31})$,其中$rk_i$(i=0,… ,31)为32比特字。轮密钥由加密密钥生成 。
-   $FK=(FK_0,FK_1,FK_2,FK_3)$为系统参数 ,$CK=(CK_0,CK_1,...CK_{31})$为固定参数 ,用于密钥扩展
算法 ,其中$FK_i(i=0,… ,3),\  CK_i(i=0,… ,31)$为字 。

### 3. 轮函数
![20220826121805](https://cdn.jsdelivr.net/gh/haocat/img_bed@master/markdown/security/20220826121805.png)
#### 3.1. 轮函数结构
设输入为$(X_0 , X_1 , X_2 , X_3 ) ∈ ( Z_2^{32})^4 $，轮密钥为$r_k∈Z_2^{32}$ ，则轮函数F为
$F(X_0 , X_1 , X_2 , X_3 , rk ) = X_0 ⊕ T ( X 1 ⊕ X 2 ⊕ X 3 ⊕ r k ) $
#### 3.2. 合成置换T
$T:Z_2^{32}$是一个可逆变换，由非线性变换$\tau$和线性变换L复合而成，即$T ( . ) = L ( τ ( . ) ) $
1.  非线性变换τ 
τ由4个并行的S盒构成(8bit输入-8bit输出)。
设输入为$A=(a_0,a_1,a_2,a_3)\in {(Z_{2}^{8})}^4$,输出为$ B=(b_0,b_1,b_2,b_3)\in {(Z_{2}^{8})}^4 $
$$(b_0,b_1,b_2,b_3)=\tau (A)=(Sbox(a_0),Sbox(a_1),Sbox(a_2),Sbox(a_3))$$
Sbox数据
![20220826112702](https://cdn.jsdelivr.net/gh/haocat/img_bed@master/markdown/security/20220826112702.png)
example：输入’EF’，则经S盒后的值为表中第E行和第F列的值，Sbox(EF)=84。

1.  线性变换L LL
非线性变换τ的输出是线性变换L的输入。设输入为$B∈Z_{2}^{32}$ ，输出为$C\in Z_{2}^{32}$
$$C=L(B)=B \oplus (B<<<2) \oplus (B<<<10) \oplus (B<<<18) \oplus (B<<<24)$$

### 4. 算法描述
![20220826115834](https://cdn.jsdelivr.net/gh/haocat/img_bed@master/markdown/security/20220826115834.png)

先将128比特密钥 MK 扩展为32个轮密钥 rk，再将该轮密钥与128比特明文 X 经过轮函数进行32次迭代后，选取最后四次迭代生成的结果 $X_{32},X_{33},X_{34},X_{35}$进行反序变换，该变换结果作为最终的密文 Y 输出。
#### 4.1. 加密算法
本加密算法由32次迭代运算和1次反序变换R RR组成。
设明文输入为$(X_0,X_1,X_2,X_3) \in {(Z_{2}^{32})}^4$，密文输出为$(Y_0,Y_1,Y_2,Y_3) \in {(Z_{2}^{32})}^4$轮密钥为${rk}_i \in Z_{2}^{32},i=0,1,2,..,31$
加密算法的运算过程如下：
1. 32次迭代运算
$$X_{i+4}=F(X_i,X_{i+1},X_{i+2},X_{i+3},{rk}_i),i=0,1,...,31 $$

2.  反序变换见式(5)：
$$ (Y_0,Y_1,Y_2,Y_3)=R(X_{32},X_{33},X_{34},X_{35})=(X_{35},X_{34},X_{33},X_{32})$$

#### 4.2. 解密算法
本算法的解密变换与加密变换结构相同，不同的仅是轮密钥的使用顺序。解密时，使用轮密钥序$({rk}_{31},{rk}_{30},...,{rk}_{0})$

#### 4.3. 密钥扩展算法
密钥扩展算法：将加密密钥变换为轮密钥的运算单元。
加密过程使用的轮密钥由加密密钥生成，其中加密密钥$MK=({MK}_0,{MK}_1,{MK}_2,{MK}_3) \in {(Z_{2}^{32})}^4$,加密过程中的轮密钥生成方法见下
$$ (K_0,K_1,K_2,K_3)=({MK}_0 \oplus {FK}_0,{MK}_1 \oplus {FK}_1,{MK}_2 \oplus {FK}_2,{MK}_3 \oplus {FK}_3) \quad$$
$$rk_i=K_{i+4}=K_{i} \oplus T'(K_{i+1} \oplus K_{i+2} \oplus K_{i+3} \oplus CK_i),\ \ i=0,1,...,31 $$

-   T′是将3.2中合成置换T的线性变换L替换为L ′,$$ {L}'(B)=B \oplus (B<<<13) \oplus (B<<<23) $$
-  系统参数FK的取值为：
$${FK}_0=(A3B1BAC6),{FK}_1=(56AA3350)$$ $${FK}_2=(677D9197),{FK}_3=(B27022DC)$$

-   固定参数CK取值方法为：
设$ck_{i,j}$为$CK_{i}$的第j字节$(i=0,1,...,31;j=0,1,2,3)$,即$CK_{i}=(ck_{i,0},ck_{i,1},ck_{i,2},ck_{i,3}) \in {(Z_{2}^{8})}^4 $,$ck_{i,j}=(4i+j) \times 7(mod \ 256)$ 
-    - 固定参数${CK}_i(i=0,1,...,31)$
具体值为：
00070E15, 1C232A31, 383F464D, 545B6269,
E0E7EEF5, FCo3oA11, 181F262D, 343B4249,
50575E65, 6C737A81, 888F969D, A4ABB2B9,
COC7CED5, DCE3EAF1, F8FF060D, 141B2229,
30373E45, 4C535A61, 686F767D, 848B9299,
AOA7AEB5, BCC3CAD1, D8DFE6ED, F4FB0209,
10171E25, 2C333A41, 484F565D, 646B7279。

![20220826121405](https://cdn.jsdelivr.net/gh/haocat/img_bed@master/markdown/security/20220826121405.png)

#### 4.4. 解密算法
本算法的解密变换与加密变换结构相同，不同的仅是轮密钥的使用顺序。

解密时，使用轮密钥序$rk_31,rk_{30},⋯,rk_0$



### SM4资源消耗部分相关
涉及到的运算操作 ⊕32位异或，<<<32位循环移位  Sbox查找表 反序变换 
Sbox查找表在加解密过程轮函数和轮密钥生成的过程中都用到
固定参数(32bits*32)${CK}_i$--预先存储还是根据地推公式实时计算当轮
#### 计算的关键路径
