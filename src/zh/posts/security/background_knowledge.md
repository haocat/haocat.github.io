# 预备知识

created@2022/08/09
<!-- 注释，你看不见我 -->
## 离散域椭圆曲线
密码学中常用的加密椭圆曲线为 $$y^2=x^3 + ax + b \ (mod) \ p $$ $4a^3 + 27 b^2 \neq 0 \ \ mod \ p$
#### 术语

+ 基点G的阶数n,$\exist n $,n=min{k,s.t   kG=O}

#### 点倍与点加
- $F_p$上的椭圆曲线

P(x1,y1) ,Q(x2,y2),  R(x3,y3)
求R=P+Q,有$$x3=k^2-x1-x2$$ $$y3=k(x1-x3)-y1$$
- 当$P = R$时,点倍运算，$k=\frac{3x1^2+a}{2y1}$
- 当$P \neq R$时,点加运算，$k=\frac{y2-y1}{x2-x1}$

简单的ECC加密通信流程如下
````txt
1、用户A选定一条椭圆曲线Ep(a,b)，并取椭圆曲线上一点，作为基点G。
2、用户A选择一个私有密钥k，并生成公开密钥K=kG。
3、用户A将Ep(a,b)和点K，G传给用户B。
4、用户B接到信息后 ，将待传输的明文编码到Ep(a,b)上一点M（编码方法很多，这里不作讨论），并产生一个随机整数r（r<n）。
5、用户B计算点C1=M+rK；C2=rG。
6、用户B将C1、C2传给用户A。
7、用户A接到信息后，计算C1-kC2，结果就是点M。因为
C1-kC2=M+rK-k(rG)=M+rK-r(kG)=M
再对点M进行解码就可以得到明文。


在这个加密通信中，如果有一个偷窥者H ，他只能看到Ep(a,b)、K、G、C1、C2 而通过K、G 求k 或通过C2、G求r 都是相对困难的。因此，H无法得到A、B间传送的明文信息。


````
![20220809111026](https://cdn.jsdelivr.net/gh/haocat/img_bed@master/markdown/security/20220809111026.png)


#### ECC 计算相关
##### 素数域下

p是一个素数，Fp由{0,1,2,··· , p−1}中p个元素构成，称Fp为素域。加法单位元是整数0，乘法
单位元是整数1，Fp的元素满足如下运算法则：
――加法：设a,b ∈ Fp，则a+b = r，其中r = (a+b) modp，r ∈ [0, p−1]。
――乘法：设a,b ∈ Fp，则a · b = s , 其中s = (a · b) modp，s ∈ [0, p−1]。
记$Fp^*$ 是由Fp中所有非零元构成的乘法群，由于$Fp^*$是循环群，所以在Fp中至少存在一个元素g，使得Fp中任一非零元都可以由g的一个方幂表示，称g为$Fp^*$的生成元(或本原元)，即$Fp^*= \{ g^i|0 ≤ i ≤ p−2 \}$ 

设$a = g^i \isin Fp^* $，其中0 ≤ i ≤ p−2，则a的乘法逆元为：$a^{−1} = g^{p−1−i}$



### 射影坐标
在椭圆曲线运算中，如果采用仿射坐标来表示椭圆曲线上的点来参与计算则需要多次计算有限域上的模逆运算，如采用射影坐标来表示椭圆曲线上的点来参与计算，可以避免用欧几里得算法计算相应的乘法逆元
#### 标准射影坐标
在仿射坐标中$y^2=x^3+ax+b$，坐标是二维的；而在射影坐标中，一个点的坐标表示为三维形式(x,y,z)
在标准射影坐标中，点$(x,y,z)$对应仿射坐标中的点 $(\frac xz,\frac yz)$；
同理有，在仿射坐标中的点(x,y)应标准射影坐标中的点(x,y,1)。

有了这样的一个对应关系，我们令椭圆曲线方程$y^2=x^3+ax+b$中$x=\frac xz\,,y=\frac yz$
​ ,就得到了标准射影坐标中的椭圆曲线方程：

$$ y^2z＝x^3＋axz^2＋bz^3 $$

可以看到，由于点(x,y,z)对应仿射坐标中的点$(\frac xz,\frac yz)$，这就使得z不能为0，如果z为零，在射影坐标中的点(0,y,0)就找不到一个对应的仿射坐标值。但实际上椭圆曲线的点还是以射影坐标为准，也就是说就是有这样一个点(0,y,0)，于是在仿射坐标中称这个点为“无穷远点”，也就是在射影坐标中这个z=0的点。
有了上面的从仿射坐标到标准射影坐标的映射关系，可以定义在标准射影坐标下的几何加法运算。令P和Q为不相等的两点$P(x_1,y_1,z_1 Q(x_2,y_2,z_2)$，令$ R(x_3,y_3,z_3)$，且R=P+Q（几何加法运算），标准射影坐标下的几何加法运算过程如下：
$\lambda_1=x_1z_2\\\lambda_2=x_2z_1\\\lambda_3=\lambda_1-\lambda_2\\\lambda_4=y_1z_2\\\lambda_5=y_2z_1\\\lambda_6=\lambda_4-\lambda_5\\\lambda_7=\lambda_1+\lambda_2\\\lambda_8=z_1z_2\\\lambda_9=\lambda_3^2\\\lambda_{10}=\lambda_3\lambda_9\\\lambda_{11}=\lambda_8\lambda_6^2-\lambda_7\lambda_9\\x_3=\lambda_3\lambda_{11}\\y_3=\lambda_6(\lambda_9\lambda_1-\lambda_{11})-\lambda_4\lambda_{10}\\z_3=\lambda_{10}\lambda_{8}$

最后得到的$x_3,y_3,z_3$,即为得到的R点标准射影坐标。

对于标量乘法中，我们首先需要计算两个相等点P+P，即计算2P，令$P(x_1,y_1,z_1)R(x_3,y_3,z_3)$ ，标准射影坐标运算过程如下：
$ λ_1 = 3x_1^2 +az^2_1\\λ_2 = 2y_1z_1\\λ_3 = y^2_1\\λ_4 = λ_3x_1z_1\\λ_5 = λ_2^2\\λ_6 = λ^2_1 −8λ_4\\ x_3 = λ_2λ_6\\y_3 = λ_1(4λ_4 −λ_6)−2λ_5λ_3\\z_3 = λ_2λ_5$
最后得到的$x_3,y_3,z_3$即为得到的R点标准射影坐标

#### Jacobian加重射影坐标
Jacobian加重射影坐标与标准射影坐标方法类似，在Jacobian加重射影坐标中，一个射影点的坐标表示为(x,y,z)，这里我们规定：
在Jacobian加重射影坐标，点)(x,y,z)对应仿射坐标中的点$(\frac {x}{z^2},\frac {y}{z^3})$；
同理有，在仿射坐标中的点x,y)对应Jacobian加重射影坐标中的点()(x,y,1)。

有了这样的一个对应关系，我们令椭圆曲线方程$y^2＝x^3＋ax＋b,\ x=\frac {x}{z^2}\,\,y=\frac {y}{z^3}$
​就得到了Jacobian加重射影坐标中的椭圆曲线方程：
$$ y^2＝x^3＋axz^4＋bz^6$$
同样可以看到，由于点(x,y,z)对应仿射坐标中的点($(\frac {x}{z^2},\frac {y}{z^3})$，当z为零，有射影坐标中的点(x,y,0)，该点同样的在仿射坐标中称为“无穷远点”，也就是在射影坐标中这个z=0的点。
##### 点加运算
有了上面的从仿射坐标到Jacobian加重射影坐标的映射关系，可以定义在Jacobian加重射影坐标下的几何加法运算。令P和Q为不相等的两点，$P(x_1,y_1,z_1) Q(x_2,y_2,z_2)$，令$R(x_3,y_3,z_3)$)，且R=P+Q（几何加法运算），Jacobian加重射影坐标下的几何加法运算过程如下：
$ λ_1=x_1z_2^2\\λ_2=x_2z_1^2\\λ_3 = λ_1 −λ_2\\λ_4 = y_1z^3_2\\λ_5 = y_2z^3_1\\λ_6 = λ_4 −λ_5\\λ_7 = λ_1 +λ_2\\ λ_8 = λ_4 +λ_5\\x_3 = λ^2_6 −λ_7λ^2_3\\λ_9 = λ_7λ^2_3 −2x_3\\y_3 = (λ_9λ_6 −λ_8λ_3^3)/2\\z_3 = z_1z_2λ_3
$
 
最后得到的$ x_3,y_3,z_3$
​
即为得到的R点Jacobian加重射影坐标。
##### 倍点运算
对于标量乘法中，我们首先需要计算两个相等点P+P，即计算2P，令$P(x_1,y_1,z_1)$Jacobian加重射影坐标运算过程如下：
$ λ_1 = 3x_1^2 +az^4_1\\λ_2 = 4x_1y^2_1\\λ_3 = 8y^4_1\\x_3 = λ^2_1 −2λ_2\\y_3 = λ_1(λ_2 −x_3)−λ_3\\z_3 = 2y_1z_1
$
 
最后得到的$x_3,y_3,z_3$
 即为得到的R点Jacobian加重射影坐标。
 
可以看到，在这两个过程中没有除法运算，也就不需要定义乘法逆元。那么这时候想要避开扩展欧几里得算法求乘法逆元就很简单了：只需将椭圆曲线在仿射坐标中的点，转化为在射影坐标中的点，用射影坐标几何加法运算得到结果点，最后再把这个点的射影坐标转化为仿射坐标就可以了。


为了减少模逆的运算次数，所有的点加和倍点操作都是在射影坐标系下进行
的，所以计算之前要把仿射坐标系下的基点转换到射影坐标系，计算完成后，需
要将射影坐标系的结果转化到仿射坐标系下。
将仿射坐标系的点（x,y）转换到Jacobian射影坐标系下：
X∈x，Y∈y，Z∈1
将Jacobian射影坐标系下的点(X,Y,Z)转换到仿射坐标系(x,y,z)：
$x=X／Z^2,y=Y／Z^3$
仿射坐标系的点转换到射影坐标系下可以直接替换，而射影坐标系转换到仿射坐标系下一般需要通过状态机控制运算顺序。


### 双线性对
若我们有加法循环群 G1 （ ，）与 G2 （ ，），循环乘法群 GT （ ，）。其中G1、G2与GT
的阶既其元素的个数为素数 N， P1与 P2分别为G1与G2的生成元。双线性对 e 为映
射GG G 1 2   T ，其满足条件以下条件：
（1）双线性性：对任意 P G 1与Q G 2 ,对于任意自然数 a 与 b，有如下等式
成立： ([ ] ,[ ] ) ( , )ab e aP bQ ePQ  ；
（2）非退化性： 1 2 eP P (, ) 1  ；
（3）可计算性：对任意 P G 1与Q G 2 ，有有效计算ePQ (, ) 1  的方法


## 求模逆——扩展欧几里得算法
在有限域上$F_p$的非零元素a的逆元记为$$a^{-1} mod \ p $$即在有限域$F_p$上存在一个唯一的一个元素x$$a \cdot x =1 \ mod \ p$$
扩展欧几里得方法求模逆
1. $u \leftarrow a,v \leftarrow p,x_1 \leftarrow 1, x_2 \leftarrow 0$
2. 当$u \neq 1$,循环执行
   $$q \leftarrow \lfloor \frac{v}{u} \rfloor,r \leftarrow v-q*u,x\leftarrow x_2 - q*x\\ v \leftarrow u ,u \leftarrow r,x_2 \leftarrow x_1,x_1 \leftarrow x$$
3. 返回$x_1$


## SM9中的塔式扩张
$𝐹𝑞^m$可由$𝐹𝑞$通过塔式扩张（Towering method）的方式构造。例如 SM9 中$𝐹q^{12}$
扩域通过 1-2-4-12 进行塔式扩张。首先由$𝐹𝑞$通过二次扩张得到扩域$𝐹𝑞^2$，继续二次
扩张的到$𝐹𝑞^4$，最终三次扩张得到$𝐹𝑞^{12}$。扩域$𝐹𝑞^{12}$上的元素可以表示为如下形式：
$
𝐹𝑞^2[𝑢] = 𝐹𝑞[𝑢]/(𝑢^2 − \alpha),  \alpha = −2;\\
𝐹𝑞^4[𝑣] = 𝐹𝑞^2[𝑣]/(𝑣^2 − \xi ), \xi= 𝑢; \\
𝐹q^{12}[𝑤] = 𝐹q^4[𝑤]/(𝑤^3 − 𝑣), 𝑣^2 = \xi ;
$
$F [x]/ m (x) $表示为模 m(x)的完全剩余类集合


Fq可以表示为F
上维度为 m 的一个向量空间，那么其中的向量由域
m
q
F
中元素
组成，系数用域
F
q
的元素表示。若

在国密 SM9 标识算法标准中关键计算为双线性对的有效计算，因此本章主要介
绍其中采用的 R-ate 对的算法研究，以 R-ate 对的定义为基础，详细介绍算法计算过
程中涉及关键步骤，主要有点加点倍、直线函数,$l_{T,Q}(P)$ 、Frobenius 分析以及最终模幂
的理论推导过程并给出分步骤计算流程。
令𝐴, 𝐵, 𝑎, 𝑏 ∈ 𝑍, 𝐴 = 𝑎𝐵 + 𝑏。那么 Miller 函数𝑓𝑄,𝐴(𝑃)具有如下性质：




可见，密钥交换算法也不算完全解决了密钥配送问题，缺陷在于无法核实对方身份。所以密钥交换算法之前一般要核实对方身份，比如使用数字签名。

是的，但是数字签名的作用本来就不是保证数据的机密性，而是证明你的身份，证明这些数据确实是由你本人发出的。